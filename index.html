<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Loadout Live</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body { margin:0; background:#111; color:#eee; font-family:Arial,sans-serif; }
h2 { text-align:center; margin:15px 0; }
.container { display:flex; gap:60px; padding:20px; }
.team { flex:1; background:#1e1e1e; padding:15px; border-radius:10px; position:relative; }
.player { background:#2b2b2b; padding:8px; margin-bottom:6px; border-radius:6px; cursor:pointer; }
.player.active { outline:2px solid #4caf50; }
.player input { width:95%; font-weight:bold; background:#222; color:#eee; border:none; outline:none; }
.loadout span { margin-right:10px; opacity:0.85; }

/* --- duplikaty --- */
.team.warning { border: 2px solid #ff3b3b; }
.team .warning-text { color:#ff3b3b; text-align:center; font-weight:bold; margin-bottom:6px; }

.player.conflict { outline:2px solid #ff3b3b; }
.player.conflict .loadout span.duplicate { color:#ff3b3b; font-weight:bold; }
.option.duplicate { border:2px solid #ff3b3b; background:#660000; color:#ff8a8a; }

.panel-container { display:flex; gap:60px; padding:0 20px; }
.panel { flex:1; margin-top:10px; padding:15px; background:#1b1b1b; border-radius:10px; }
.section { margin-bottom:12px; }
.options { display:flex; flex-wrap:wrap; gap:6px; }
.option { padding:6px 10px; background:#444; border-radius:5px; cursor:pointer; user-select:none; }
.option.disabled { opacity:0.3; cursor:not-allowed; }
.option.active { outline:2px solid #4caf50; }
.admin { text-align:center; margin-bottom:15px; }
button { padding:6px 12px; margin:4px; }
select { padding:6px; }
</style>
</head>
<body>

<h2>Loadout Live</h2>

<div class="container">
  <div class="team" id="teamAContainer">
    <div class="warning-text" id="warningA" style="display:none">‚ö†Ô∏è Duplikaty w dru≈ºynie!</div>
    <h3>Dru≈ºyna A</h3>
    <div id="teamA"></div>
  </div>
  <div class="team" id="teamBContainer">
    <div class="warning-text" id="warningB" style="display:none">‚ö†Ô∏è Duplikaty w dru≈ºynie!</div>
    <h3>Dru≈ºyna B</h3>
    <div id="teamB"></div>
  </div>
</div>

<div class="panel-container">
  <div class="panel">
    <h4>Opcje Dru≈ºyny A</h4>
    <div class="section"><b>Tytany</b><div class="options" id="titansA"></div></div>
    <div class="section"><b>Bronie ciƒô≈ºkie</b><div class="options" id="weaponsA"></div></div>
    <div class="section"><b>Umiejƒôtno≈õci taktyczne</b><div class="options" id="tacticalsA"></div></div>
  </div>

  <div class="panel">
    <h4>Opcje Dru≈ºyny B</h4>
    <div class="section"><b>Tytany</b><div class="options" id="titansB"></div></div>
    <div class="section"><b>Bronie ciƒô≈ºkie</b><div class="options" id="weaponsB"></div></div>
    <div class="section"><b>Umiejƒôtno≈õci taktyczne</b><div class="options" id="tacticalsB"></div></div>
  </div>
</div>

<div class="admin" id="adminPanel" style="display:none">
  <button onclick="addPlayer()">‚ûï Dodaj gracza</button>
  <button onclick="movePlayer()">‚áÑ Przenie≈õ gracza</button>
  <button onclick="resetLoadouts()">üîÑ Reset loadout√≥w</button>
  <br><br>
  Tryb:
  <select onchange="setMode(this.value)">
    <option value="10">10 graczy</option>
    <option value="12">12 graczy</option>
    <option value="14">14 graczy</option>
  </select>
</div>

<script>
/* ===== FIREBASE ===== */
const firebaseConfig = {
  apiKey: "AIzaSyCIi8Jl0rEPsNOfFERMUSl-MV3lDiEOsVI",
  authDomain: "tabela-turniejowa-titanfall-2.firebaseapp.com",
  databaseURL: "https://tabela-turniejowa-titanfall-2-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "tabela-turniejowa-titanfall-2",
  storageBucket: "tabela-turniejowa-titanfall-2.firebasestorage.app",
  messagingSenderId: "887537927614",
  appId: "1:887537927614:web:28f6f7e303e1a57d00e5ef"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ===== ADMIN ===== */
const isAdmin = location.search.includes("admin=1");
if(isAdmin) document.getElementById("adminPanel").style.display="block";

/* ===== STA≈ÅE ===== */
const TITANS = ["Kationa","Spopielacz","Polaris","Ronin","Ton","Legion","Monarcha"];
const WEAPONS = ["Granat od≈Çamkowy","Granat ≈Çukowy","Ognista gwiazda","Gwiazda grawitacyjna","Granat elektro-dymny","Ciƒô≈ºki ≈Çadunek wybuchowy"];
const TACTICALS = ["Maskowanie","Ostrze pulsacyjne","Linka z hakiem","Stymulant","≈öciana energetyczna","Przeskok fazowy","Holopilot"];
const LIMITED_TACTICALS = ["Ostrze pulsacyjne","≈öciana energetyczna"];

let activePlayer = null;
let teamsData = { A:{}, B:{} };
let maxPlayers = 10;

/* ===== DUPLIKATY ===== */
function getDuplicates(team, field){
  const vals = [];
  Object.entries(teamsData[team]||{}).forEach(([id,p])=>{
    const v = p[field];
    if(v) vals.push(v);
  });
  return vals.filter((v,i,a)=>a.indexOf(v)!==i);
}

function hasConflict(team, playerId){
  const p = teamsData[team]?.[playerId];
  if(!p) return false;
  if(p.titan && getDuplicates(team,"titan").includes(p.titan)) return true;
  if(p.heavy && p.heavy!=="Ognista gwiazda" && getDuplicates(team,"heavy").includes(p.heavy)) return true;
  if(p.tactical && LIMITED_TACTICALS.includes(p.tactical) && getDuplicates(team,"tactical").includes(p.tactical)) return true;
  return false;
}

/* ===== RENDER DRU≈ªYN ===== */
function renderTeam(team){
  db.ref("teams/"+team).on("value", snap=>{
    teamsData[team] = snap.val() || {};
    const box = document.getElementById("team"+team);
    const warning = document.getElementById("warning"+team);
    box.innerHTML = "";

    // sprawdzenie czy dru≈ºyna ma jakiekolwiek duplikaty
    let teamHasDuplicates = false;
    Object.entries(teamsData[team]).forEach(([id,p])=>{
      if(hasConflict(team,id)) teamHasDuplicates=true;
    });
    if(teamHasDuplicates){
      warning.style.display="block";
      document.getElementById("team"+team+"Container").classList.add("warning");
    } else {
      warning.style.display="none";
      document.getElementById("team"+team+"Container").classList.remove("warning");
    }

    Object.entries(teamsData[team]).forEach(([id,p])=>{
      const div = document.createElement("div");
      div.className = "player";
      if(activePlayer && activePlayer.id===id) div.classList.add("active");

      // konflikt w kom√≥rce
      if(hasConflict(team,id)) div.classList.add("conflict");

      // tekst w kom√≥rce dla duplikat√≥w
      div.innerHTML=`
        <input value="${p.nick||''}" ${isAdmin?'':'disabled'}>
        <div class="loadout">
          <span class="${getDuplicates(team,"titan").includes(p.titan)?'duplicate':''}">${p.titan||'‚Äî'}</span>
          <span class="${(p.heavy!=="Ognista gwiazda" && getDuplicates(team,"heavy").includes(p.heavy))?'duplicate':''}">${p.heavy||'‚Äî'}</span>
          <span class="${(LIMITED_TACTICALS.includes(p.tactical) && getDuplicates(team,"tactical").includes(p.tactical))?'duplicate':''}">${p.tactical||'‚Äî'}</span>
        </div>`;

      div.onclick=()=>{
        document.querySelectorAll(".player").forEach(el=>el.classList.remove("active"));
        activePlayer={team,id,playerData:{...p}};
        div.classList.add("active");
        renderOptions();
      };

      const input = div.querySelector("input");
      input.onclick=e=>e.stopPropagation();
      input.addEventListener("keydown",e=>{
        if(e.key==="Enter"){ db.ref(`teams/${team}/${id}/nick`).set(input.value); input.blur(); }
        else if(e.key==="Escape"){ input.value=p.nick||""; input.blur(); }
      });

      box.appendChild(div);
    });
    renderOptions();
  });
}
renderTeam("A"); renderTeam("B");

/* ===== BLOKADY WEWNƒÑTRZ DRU≈ªYNY ===== */
function canUse(field,value,team,idIgnore){
  let taken=false;
  Object.entries(teamsData[team]||{}).forEach(([id,p])=>{
    if(idIgnore===id) return;
    if(field==="titan" && p.titan===value) taken=true;
    if(field==="heavy" && value!=="Ognista gwiazda" && p.heavy===value) taken=true;
    if(field==="tactical" && LIMITED_TACTICALS.includes(value) && p.tactical===value) taken=true;
  });
  return !taken;
}

/* ===== PANEL OPCJI DLA DW√ìCH DRU≈ªYN ===== */
function renderOptions(){
  renderTeamOptions('A'); 
  renderTeamOptions('B');
}

function renderTeamOptions(team){
  makeOptions(TITANS,`titans${team}`,"titan",team);
  makeOptions(WEAPONS,`weapons${team}`,"heavy",team);
  makeOptions(TACTICALS,`tacticals${team}`,"tactical",team);
}

function makeOptions(list,target,field,team){
  const el=document.getElementById(target); el.innerHTML="";
  const duplicates = getDuplicates(team,field);

  list.forEach(val=>{
    const o=document.createElement("div");
    o.className="option"; o.innerText=val;

    // pod≈õwietlenie w puli
    if(duplicates.includes(val) && ((field==="heavy" && val!=="Ognista gwiazda") || field==="titan" || (field==="tactical" && LIMITED_TACTICALS.includes(val)))) {
      o.classList.add("duplicate");
    }

    if(activePlayer && activePlayer.team===team){
      const current = activePlayer.playerData[field];
      if(current===val) o.classList.add("active");
      else if(!canUse(field,val,team,activePlayer.id)) o.classList.add("disabled");
    }

    o.onclick=()=>{
      if(!activePlayer || activePlayer.team!==team) return alert("Najpierw wybierz gracza z tej dru≈ºyny");
      const current = activePlayer.playerData[field];

      if(current===val){
        db.ref(`teams/${activePlayer.team}/${activePlayer.id}/${field}`).set("").then(()=>{
          activePlayer.playerData[field]="";
          renderOptions();
        });
        return;
      }
      if(!canUse(field,val,team,activePlayer.id)) return;
      db.ref(`teams/${activePlayer.team}/${activePlayer.id}/${field}`).set(val).then(()=>{
        activePlayer.playerData[field]=val;
        renderOptions();
      });
    };
    el.appendChild(o);
  });
}

/* ===== ADMIN ===== */
function addPlayer(){
  const total = Object.keys(teamsData.A||{}).length + Object.keys(teamsData.B||{}).length;
  if(total>=maxPlayers) return alert("OsiƒÖgniƒôto limit graczy");
  const team = (Object.keys(teamsData.A||{}).length <= Object.keys(teamsData.B||{}).length) ? "A":"B";
  const id="p"+Date.now();
  db.ref(`teams/${team}/${id}`).set({nick:"Nowy gracz",titan:"",heavy:"",tactical:""});
}

function movePlayer(){
  if(!activePlayer) return;
  const from=activePlayer.team, to=(from==="A")?"B":"A", id=activePlayer.id;
  db.ref(`teams/${from}/${id}`).once("value",snap=>{
    const data=snap.val(); if(!data) return;
    const updates={};
    updates[`teams/${to}/${id}`]=data; updates[`teams/${from}/${id}`]=null;
    db.ref().update(updates); activePlayer=null;
  });
}

function resetLoadouts(){
  ["A","B"].forEach(team=>{
    Object.keys(teamsData[team]||{}).forEach(id=>{
      db.ref(`teams/${team}/${id}`).update({titan:"",heavy:"",tactical:""});
    });
  });
}

function setMode(val){ maxPlayers=parseInt(val); }

</script>
</body>
</html>
