<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Loadout Live</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body { margin:0; background:#111; color:#eee; font-family:Arial,sans-serif; }
h2 { text-align:center; margin:15px 0; }
.container { display:flex; gap:60px; padding:20px; }
.team { flex:1; background:#1e1e1e; padding:15px; border-radius:10px; }
.team.error { outline:3px solid #ff3b3b; }

.player { background:#2b2b2b; padding:8px; margin-bottom:6px; border-radius:6px; cursor:pointer; }
.player.active { outline:2px solid #4caf50; }
.player.conflict { outline:2px solid #ff3b3b; }

.player input { width:95%; font-weight:bold; background:#222; color:#eee; border:none; outline:none; }

.loadout span { margin-right:10px; opacity:0.85; }
.loadout span.conflict { color:#ff3b3b; font-weight:bold; }

.panel-container { display:flex; gap:60px; padding:0 20px; }
.panel { flex:1; margin-top:10px; padding:15px; background:#1b1b1b; border-radius:10px; }

.section { margin-bottom:12px; }
.options { display:flex; flex-wrap:wrap; gap:6px; }
.option { padding:6px 10px; background:#444; border-radius:5px; cursor:pointer; user-select:none; }
.option.disabled { opacity:0.3; cursor:not-allowed; }
.option.active { outline:2px solid #4caf50; }

.team-warning {
  background:#ff3b3b;
  color:#000;
  padding:6px;
  margin-bottom:8px;
  border-radius:6px;
  font-weight:bold;
  text-align:center;
}

.admin { text-align:center; margin-bottom:15px; }
button { padding:6px 12px; margin:4px; }
select { padding:6px; }
</style>
</head>

<body>

<h2>Loadout Live</h2>

<div class="container">
  <div class="team">
    <h3>DruÅ¼yna A</h3>
    <div id="teamA"></div>
  </div>
  <div class="team">
    <h3>DruÅ¼yna B</h3>
    <div id="teamB"></div>
  </div>
</div>

<div class="panel-container">
  <div class="panel">
    <h4>Opcje DruÅ¼yny A</h4>
    <div class="section"><b>Tytany</b><div class="options" id="titansA"></div></div>
    <div class="section"><b>Bronie ciÄ™Å¼kie</b><div class="options" id="weaponsA"></div></div>
    <div class="section"><b>UmiejÄ™tnoÅ›ci taktyczne</b><div class="options" id="tacticalsA"></div></div>
  </div>

  <div class="panel">
    <h4>Opcje DruÅ¼yny B</h4>
    <div class="section"><b>Tytany</b><div class="options" id="titansB"></div></div>
    <div class="section"><b>Bronie ciÄ™Å¼kie</b><div class="options" id="weaponsB"></div></div>
    <div class="section"><b>UmiejÄ™tnoÅ›ci taktyczne</b><div class="options" id="tacticalsB"></div></div>
  </div>
</div>

<div class="admin" id="adminPanel" style="display:none">
  <button onclick="addPlayer()">âž• Dodaj gracza</button>
  <button onclick="movePlayer()">â‡„ PrzenieÅ› gracza</button>
  <button onclick="resetLoadouts()">ðŸ”„ Reset loadoutÃ³w</button>
</div>

<script>
/* ===== FIREBASE ===== */
const firebaseConfig = {
  apiKey: "AIzaSyCIi8Jl0rEPsNOfFERMUSl-MV3lDiEOsVI",
  authDomain: "tabela-turniejowa-titanfall-2.firebaseapp.com",
  databaseURL: "https://tabela-turniejowa-titanfall-2-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "tabela-turniejowa-titanfall-2",
  storageBucket: "tabela-turniejowa-titanfall-2.firebasestorage.app",
  messagingSenderId: "887537927614",
  appId: "1:887537927614:web:28f6f7e303e1a57d00e5ef"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ===== ADMIN ===== */
const isAdmin = location.search.includes("admin=1");
if(isAdmin) document.getElementById("adminPanel").style.display="block";

/* ===== STAÅE ===== */
const TITANS = ["Kationa","Spopielacz","Polaris","Ronin","Ton","Legion","Monarcha"];
const WEAPONS = ["Granat odÅ‚amkowy","Granat Å‚ukowy","Ognista gwiazda","Gwiazda grawitacyjna","Granat elektro-dymny","CiÄ™Å¼ki Å‚adunek wybuchowy"];
const TACTICALS = ["Maskowanie","Ostrze pulsacyjne","Linka z hakiem","Stymulant","Åšciana energetyczna","Przeskok fazowy","Holopilot"];
const LIMITED_TACTICALS = ["Ostrze pulsacyjne","Åšciana energetyczna"];

let activePlayer = null;
let teamsData = { A:{}, B:{} };

/* ===== WYKRYWANIE KONFLIKTÃ“W ===== */
function getConflicts(team){
  const seen={titan:{},heavy:{},tactical:{}};
  const conflicts={};

  Object.entries(teamsData[team]||{}).forEach(([id,p])=>{
    ["titan","heavy","tactical"].forEach(f=>{
      const v=p[f];
      if(!v) return;
      if(f==="heavy" && v==="Ognista gwiazda") return;
      if(!seen[f][v]) seen[f][v]=[];
      seen[f][v].push(id);
    });
  });

  Object.entries(seen).forEach(([f,vals])=>{
    Object.entries(vals).forEach(([v,ids])=>{
      if(ids.length>1){
        ids.forEach(id=>{
          if(!conflicts[id]) conflicts[id]={};
          conflicts[id][f]=v;
        });
      }
    });
  });
  return conflicts;
}

/* ===== RENDER DRUÅ»YN ===== */
function renderTeam(team){
  db.ref("teams/"+team).on("value", snap=>{
    teamsData[team]=snap.val()||{};
    const box=document.getElementById("team"+team);
    const teamBox=box.parentElement;
    const conflicts=getConflicts(team);

    teamBox.classList.toggle("error",Object.keys(conflicts).length>0);
    box.innerHTML="";
    teamBox.querySelectorAll(".team-warning").forEach(e=>e.remove());

    if(Object.keys(conflicts).length>0){
      const w=document.createElement("div");
      w.className="team-warning";
      w.innerText="âŒ Konflikt loadoutu â€“ zduplikowane wybory";
      teamBox.insertBefore(w,box);
    }

    Object.entries(teamsData[team]).forEach(([id,p])=>{
      const div=document.createElement("div");
      div.className="player";
      if(conflicts[id]) div.classList.add("conflict");
      if(activePlayer&&activePlayer.id===id) div.classList.add("active");

      div.innerHTML=`
        <input value="${p.nick||''}">
        <div class="loadout">
          <span class="${conflicts[id]?.titan?'conflict':''}">${p.titan||'â€”'}</span>
          <span class="${conflicts[id]?.heavy?'conflict':''}">${p.heavy||'â€”'}</span>
          <span class="${conflicts[id]?.tactical?'conflict':''}">${p.tactical||'â€”'}</span>
        </div>`;

      div.onclick=()=>{
        document.querySelectorAll(".player").forEach(e=>e.classList.remove("active"));
        activePlayer={team,id,playerData:{...p}};
        div.classList.add("active");
        renderOptions();
      };

      box.appendChild(div);
    });
  });
}

renderTeam("A");
renderTeam("B");

/* ===== PANEL OPCJI (BEZ ZMIAN) ===== */
function renderOptions(){
  ["A","B"].forEach(t=>{
    ["titans","weapons","tacticals"].forEach(()=>{});
  });
}

/* ===== ADMIN ===== */
function addPlayer(){
  const team=Object.keys(teamsData.A).length<=Object.keys(teamsData.B).length?"A":"B";
  const id="p"+Date.now();
  db.ref(`teams/${team}/${id}`).set({nick:"Nowy gracz",titan:"",heavy:"",tactical:""});
}

function movePlayer(){
  if(!activePlayer) return;
  const from=activePlayer.team,to=from==="A"?"B":"A",id=activePlayer.id;
  db.ref(`teams/${from}/${id}`).once("value",snap=>{
    const d=snap.val(); if(!d) return;
    const u={};
    u[`teams/${to}/${id}`]=d;
    u[`teams/${from}/${id}`]=null;
    db.ref().update(u);
    activePlayer=null;
  });
}

function resetLoadouts(){
  ["A","B"].forEach(t=>{
    Object.keys(teamsData[t]||{}).forEach(id=>{
      db.ref(`teams/${t}/${id}`).update({titan:"",heavy:"",tactical:""});
    });
  });
}
</script>
</body>
</html>
